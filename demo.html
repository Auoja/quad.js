<!DOCTYPE html>
<html>
    <head>
        <title>Q-Tree Demo</title>
    </head>
    <script src="quad.js"></script>
    <script>
        function setup() {

            var canvas = document.getElementById("canvas");
            canvas.addEventListener("mousedown", mousedown, false);

            var drag = false;
            var select = false;
            var startX;
            var startY;
            var endX;
            var endY;

            var rect = canvas.getBoundingClientRect();

            var ctx = canvas.getContext('2d');
            ctx.lineWidth = 1;

            var q = Quad.create({
                x: 0,
                y: 0,
                w: canvas.width,
                h: canvas.height,
                capacity: 1
            });

            function mousedown(event) {
                canvas.addEventListener("mouseup", mouseup, false);
                canvas.addEventListener("mousemove", mousemove, false);
                startX = event.x;
                startY = event.y;
                select = false;
            }

            function mousemove(event) {
                endX = event.x;
                endY = event.y;
                drag = true;
            }

            function mouseup(event) {
                endX = event.x;
                endY = event.y;

                if (drag) {
                    drag = false;
                    select = true;
                } else {
                    q.insert({x: event.x - rect.left, y: event.y - rect.top, w: 0, h: 0});
                }

                canvas.removeEventListener("mouseup", mouseup, false);
                canvas.removeEventListener("mousemove", mousemove, false);
            }

            function render() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                q.toArray().forEach(function(item) {
                    ctx.beginPath();
                    ctx.fillStyle = "red";
                    for ( var i = item.nodes.length - 1; i >= 0; i--) {
                        var node = item.nodes[i];
                        ctx.fillRect(node.x - 2, node.y - 2, 4, 4);
                    }
                    ctx.closePath();
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.strokeStyle = "black";
                    ctx.rect(item.bBox.getLeft(), item.bBox.getTop(), item.bBox.getWidth(), item.bBox.getHeight());
                    ctx.closePath();
                    ctx.stroke();
                });
                if (drag) {
                    ctx.beginPath();
                    ctx.strokeStyle = "green";
                    ctx.rect(startX, startY, (endX - startX), (endY - startY));
                    ctx.closePath();
                    ctx.stroke();
                }
                if (select) {
                    q.retrieve({
                        x: startX,
                        y: startY,
                        w: (endX - startX),
                        h: (endY - startY)
                    }).forEach(function(item) {
                        ctx.beginPath();
                        ctx.strokeStyle = "green";
                        ctx.arc(item.x, item.y, 5, 0, 2 * Math.PI);
                        ctx.closePath();
                        ctx.stroke();
                    });
                }
                ctx.closePath();
            }

            for ( var i = 0; i < 100; i++) {
                q.insert({x: Math.floor(Math.random() * canvas.width), y: Math.floor(Math.random() * canvas.height), w: 0, h: 0});
            }

            setInterval(render, 32);
        }
    </script>
    <body onload="setup()">
        <canvas id="canvas" width="512" height="512"></canvas>
    </body>
</html>
